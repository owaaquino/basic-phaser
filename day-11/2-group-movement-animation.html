<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Setup</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
      body {
        margin: 0;
        background: #222;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      h1 {
        color: white;
      }
    </style>
  </head>
  <body>
    <h1>Learning Phaser</h1>
    <div id="game-container"></div>
    <script>
      class GameScene extends Phaser.Scene {
        constructor() {
          super({ key: 'GameScene' });
        }

        preload() {
          this.load.spritesheet('astronaut-idle', 'assets/astronaut-idle.png', {
            frameWidth: 24,
            frameHeight: 24,
          });

          this.load.spritesheet('astronaut-run', 'assets/astronaut-run.png', {
            frameWidth: 24,
            frameHeight: 24,
          });

          this.load.spritesheet('astronaut-jump', 'assets/astronaut-jump.png', {
            frameWidth: 24,
            frameHeight: 24,
          });

          this.load.spritesheet(
            'astronaut-death',
            'assets/astronaut-death.png',
            {
              frameWidth: 24,
              frameHeight: 24,
            },
          );

          this.load.spritesheet('alien-idle', 'assets/alien-idle.png', {
            frameWidth: 32,
            frameHeight: 32,
          });

          this.load.spritesheet('alien-run', 'assets/alien-run.png', {
            frameWidth: 32,
            frameHeight: 32,
          });

          this.load.spritesheet('alien-jump', 'assets/alien-jump.png', {
            frameWidth: 32,
            frameHeight: 32,
          });

          this.load.spritesheet('alien-death', 'assets/alien-death.png', {
            frameWidth: 32,
            frameHeight: 32,
          });

          this.load.image('platform', 'assets/platform.png');
          this.load.image('star', 'assets/star.png');
        }

        create() {
          // use a sprite (not an Image) so animations are available
          this.player = this.physics.add.sprite(200, 500, 'astronaut-idle');

          this.player.body.setSize(15, 15);
          this.player.body.setOffset(5, 5);

          // Create a ground platform staticGroup
          this.platforms = this.physics.add.staticGroup();
          this.platforms.create(400, 568, 'platform').setScale(2).refreshBody();

          // create a group of stars
          this.enemies = this.physics.add.group({
            key: 'alien-idle',
            repeat: 5,
            setXY: { x: 500, y: 500, stepX: 30 },
            collideWorldBounds: true,
          });

          this.anims.create({
            key: 'walk',
            frames: this.anims.generateFrameNumbers('astronaut-run', {
              start: 0,
              end: 3,
            }),
            frameRate: 10,
            repeat: -1,
          });

          this.anims.create({
            key: 'idle',
            frames: this.anims.generateFrameNumbers('astronaut-idle', {
              start: 0,
              end: 3,
            }),
            frameRate: 10,
            repeat: -1,
          });

          this.anims.create({
            key: 'jump',
            frames: this.anims.generateFrameNumbers('astronaut-jump', {
              start: 0,
              end: 3,
            }),
            frameRate: 10,
            repeat: -1,
          });

          this.anims.create({
            key: 'enemy-idle',
            frames: this.anims.generateFrameNumbers('alien-idle', {
              start: 0,
              end: 3,
            }),
            frameRate: 10,
            repeat: -1,
          });

          this.anims.create({
            key: 'enemy-walk',
            frames: this.anims.generateFrameNumbers('alien-run', {
              start: 0,
              end: 3,
            }),
            frameRate: 10,
            repeat: -1,
          });

          this.enemies.children.iterate(function (child) {
            child.setBounceY(Phaser.Math.FloatBetween(0.1, 0.3));
          });

          this.cursor = this.input.keyboard.createCursorKeys();

          this.physics.add.collider(this.player, this.platforms);
          this.physics.add.collider(this.enemies, this.platforms);

          // player collide with world bound
          this.player.setCollideWorldBounds(true);

          // player can trigger world bound event
          this.player.body.onWorldBounds = true;

          // console log when player hit the world bound
          this.physics.world.on('worldbounds', (body) => {
            console.log('Player hit the world bound!');
          });
        }

        update() {
          if (this.cursor.left.isDown) {
            this.player.setVelocityX(-160);
            this.player.flipX = true;
          } else if (this.cursor.right.isDown) {
            this.player.setVelocityX(160);
            this.player.flipX = false;
          } else {
            this.player.setVelocityX(0);
          }

          if (this.cursor.up.isDown && this.player.body.touching.down) {
            this.player.setVelocityY(-150);
          }

          if (!this.player.body.touching.down) {
            this.player.anims.play('jump', true);
          } else if (this.player.body.velocity.x !== 0) {
            this.player.anims.play('walk', true);
          } else {
            this.player.anims.play('idle', true);
          }

          this.enemies.children.iterate(function (child) {
            child.setSize(15, 15);
            child.setOffset(10, 9);

            if (child.body.velocity.x === 0) {
              const direction = Phaser.Math.RND.pick([-50, 50]); // randomly pick left or right
              child.setVelocityX(direction);
              child.anims.play('enemy-walk', true);
              if (child.body.velocity.x < 0) {
                child.flipX = true;
              } else {
                child.flipX = false;
              }
            }
          });
        }
      }

      const config = {
        type: Phaser.AUTO, // Uses WebGL if available, otherwise Canvas
        parent: 'game-container', // displays the game in this div
        width: 800,
        height: 600,
        physics: {
          default: 'arcade',
          arcade: {
            gravity: { y: 300 }, // Objects will fall down
            debug: true,
          },
        },
        scale: {
          mode: Phaser.Scale.FIT,
          autoCenter: Phaser.Scale.CENTER_BOTH,
        },
        scene: GameScene,
      };

      const game = new Phaser.Game(config);
    </script>
  </body>
</html>
